From foo@baz Tue May  1 16:18:20 PDT 2018
From: Benoit Parrot <bparrot@ti.com>
Date: Mon, 16 May 2016 16:42:50 -0500
Subject: drm/omap: Add pclk setting case when channel is DSS_WB

From: Benoit Parrot <bparrot@ti.com>

[ Upstream commit 9deb5ad3c47ead2b3c63e44435e9eff0f6f38835 ]

In dispc_set_ovl_common() we need to initialize pclk to a valid
value when we use WB in capture mode (i.e. mem_2_mem is false).
Otherwise dispc_ovl_calc_scaling() fails.

Signed-off-by: Benoit Parrot <bparrot@ti.com>
Signed-off-by: Tomi Valkeinen <tomi.valkeinen@ti.com>
Signed-off-by: Sasha Levin <alexander.levin@microsoft.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@linuxfoundation.org>
---
 drivers/gpu/drm/omapdrm/dss/dispc.c |    4 ++++
 1 file changed, 4 insertions(+)

--- a/drivers/gpu/drm/omapdrm/dss/dispc.c
+++ b/drivers/gpu/drm/omapdrm/dss/dispc.c
@@ -2491,6 +2491,10 @@ static int dispc_ovl_setup_common(enum o
 	unsigned long pclk = dispc_plane_pclk_rate(plane);
 	unsigned long lclk = dispc_plane_lclk_rate(plane);
 
+	/* when setting up WB, dispc_plane_pclk_rate() returns 0 */
+	if (plane == OMAP_DSS_WB)
+		pclk = vm->pixelclock;
+
 	if (paddr == 0 && rotation_type != OMAP_DSS_ROT_TILER)
 		return -EINVAL;
 
