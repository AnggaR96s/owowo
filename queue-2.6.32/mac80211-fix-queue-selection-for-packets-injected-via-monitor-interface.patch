From 045cfb71a3901005bf6dcedae98cecb3360a0bfc Mon Sep 17 00:00:00 2001
From: Lennert Buytenhek <buytenh@wantstofly.org>
Date: Thu, 7 Jan 2010 15:01:42 +0100
Subject: mac80211: fix queue selection for packets injected via monitor interface

From: Lennert Buytenhek <buytenh@wantstofly.org>

commit 045cfb71a3901005bf6dcedae98cecb3360a0bfc upstream.

Commit 'mac80211: fix skb buffering issue' added an ->ndo_select_queue()
for monitor interfaces which can end up dereferencing ieee802_1d_to_ac[]
beyond the end of the array for injected data packets (as skb->priority
isn't guaranteed to be zero or within [0:7]), which then triggers the
WARN_ON in net/core/dev.c:dev_cap_txqueue().  Fix this by always setting
the priority to zero on injected data frames.

Signed-off-by: Lennert Buytenhek <buytenh@marvell.com>
Signed-off-by: John W. Linville <linville@tuxdriver.com>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 net/mac80211/iface.c |    1 +
 1 file changed, 1 insertion(+)

--- a/net/mac80211/iface.c
+++ b/net/mac80211/iface.c
@@ -683,6 +683,7 @@ static u16 ieee80211_monitor_select_queu
 		return ieee802_1d_to_ac[skb->priority];
 	}
 
+	skb->priority = 0;
 	return ieee80211_downgrade_queue(local, skb);
 }
 
