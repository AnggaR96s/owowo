From stable-bounces@linux.kernel.org Mon Feb  5 06:22:51 2007
From: Tejun Heo <htejun@gmail.com>
Date: Mon, 5 Feb 2007 23:21:19 +0900
Subject: libata: fix drive side 80c cable check
To: Alan <alan@lxorguk.ukuu.org.uk>
Cc: linux-ide@vger.kernel.org, stable@kernel.org, Jeff Garzik <jeff@garzik.org>
Message-ID: <20070205142119.GM1625@htj.dyndns.org>
Content-Disposition: inline


From: Tejun Heo <htejun@gmail.com>

The 80c wire bit is bit 13, not 14.  Bit 14 is always 1 if word93 is
implemented.  This increases the chance of incorrect wire detection
especially because host side cable detection is often unreliable and
we sometimes soley depend on drive side cable detection.  Fix the test
and add word93 validity check.

Signed-off-by: Tejun Heo <htejun@gmail.com>
Acked-by: Alan Cox <alan@redhat.com>
Cc: Jeff Garzik <jeff@garzik.org>
Signed-off-by: Greg Kroah-Hartman <gregkh@suse.de>

---
 include/linux/ata.h |    2 +-
 1 file changed, 1 insertion(+), 1 deletion(-)

--- linux-2.6.20.1.orig/include/linux/ata.h
+++ linux-2.6.20.1/include/linux/ata.h
@@ -347,7 +347,7 @@ static inline int ata_drive_40wire(const
 {
 	if (ata_id_major_version(dev_id) >= 5 && ata_id_is_sata(dev_id))
 		return 0;	/* SATA */
-	if (dev_id[93] & 0x4000)
+	if ((dev_id[93] & 0xE000) == 0x6000)
 		return 0;	/* 80 wire */
 	return 1;
 }
