#!/bin/bash

# locations of some things that you might want to override if you are a
# different developer than gregkh
STABLE_QUEUE="/home/gregkh/linux/stable/stable-queue/"
TMP_DIR="/home/gregkh/linux/tmp/"


SCRIPT_NAME=`basename ${0}`
MBOX="$1"
if [ "${MBOX}" == "" ] ; then
	echo "ERROR, you must specify a mailbox name."
	echo "usage:"
	echo "    ${SCRIPT_NAME} mailbox_name"
	exit
fi

FULL_VERSION=`ketchup -m`
BASE_VERSION=${FULL_VERSION/-rc?/}
VERSION=`basename \`pwd\``
ROOT_VERSION=${VERSION/\.y/}
ROOT_VERSION=${ROOT_VERSION/linux-/}
DATE=`date -u --date="2 days"`

if [ ${FULL_VERSION} == ${BASE_VERSION} ] ; then
	echo "Makefile says the version is ${FULL_VERSION}, did you forget to set the -rc version?"
	exit
fi

if [ ! -f "diffstat" ] ; then
	echo "You forgot to create the 'diffstat' file, please do that first."
	exit
fi

# create a directory for everything to live in
TMP_DIR=`mktemp -d ${TMP_DIR}/stable-${ROOT_VERSION}-XXXX` || exit 1


# make a git tree to create the log file in the format that Linus likes.
#
# note, we could be getting the diffstat here as well, which might be a nice
# thing, but currently we create it from the make_diff script, and sign it
# there, but the next time someone adds a file to the tree with a patch, I'll
# rewrite this to create it here, no need to do things in two different stages.
echo "Creating a git tree of the commits..."
ORIGINAL_DIR=`pwd`
TMP_TREE=`mktemp -d ${TMP_DIR}/stable-${ROOT_VERSION}-XXXX` || exit 1
TMP_LOG=`mktemp ${TMP_DIR}/stable-log-XXXX` || exit 1
git clone -s . ${TMP_TREE}
cd ${TMP_TREE}
git checkout -b temp_branch
git quiltimport --patches=${STABLE_QUEUE}/queue-${ROOT_VERSION}
git log --abbrev=12 --format="%aN <%aE>%n    %s%n" ${VERSION}..HEAD > ${TMP_LOG}
cd ${ORIGINAL_DIR}
rm -rf ${TMP_TREE}
#exit


echo "Creating the mailbox for kernel release ${FULL_VERSION}"
TMPFILE=`mktemp ${TMP_DIR}/stable_header.XXXXXX` || exit 1
NUM_PATCHES=`quilt series | wc -l`

(
echo "This is the start of the stable review cycle for the ${BASE_VERSION} release."
echo "There are ${NUM_PATCHES} patches in this series, all will be posted as a response"
echo "to this one.  If anyone has any issues with these being applied, please"
echo "let me know."
echo ""
echo "Responses should be made by ${DATE}."
echo "Anything received after that time might be too late."
echo ""
echo "The whole patch series can be found in one patch at:"
echo "	kernel.org/pub/linux/kernel/v3.0/stable-review/patch-${FULL_VERSION}.gz"
echo "and the diffstat can be found below."
echo ""
echo "thanks,"
echo ""
echo "greg k-h"
echo ""
echo "-------------"
echo "Pseudo-Shortlog of commits:"
echo ""
cat ${TMP_LOG}
#stable-shortlog
echo ""
echo "-------------"
echo ""
echo "Diffstat:"
echo ""

cat diffstat
) > ${TMPFILE}

FROM="Greg Kroah-Hartman <gregkh@linuxfoundation.org>"
TO="linux-kernel@vger.kernel.org, stable@vger.kernel.org"
#CC="torvalds@linux-foundation.org, akpm@linux-foundation.org, alan@lxorguk.ukuu.org.uk"
CC="alan@lxorguk.ukuu.org.uk"
SUBJECT="${BASE_VERSION}-stable review"

quilt mail --mbox ${TMP_DIR}/${MBOX}	\
	-m "$(cat ${TMPFILE})"	\
	--sender "${FROM}"	\
	--from "${FROM}"	\
	--to "${TO}"		\
	--cc "${CC}"		\
	--prefix ""		\
	--subject "${SUBJECT}"

rm ${TMPFILE} ${TMP_LOG}

echo "mbox is now in ${TMP_DIR}/${MBOX}"

echo "Add:"
echo "Cc: torvalds@linux-foundation.org, akpm@linux-foundation.org"
echo "to the first email."

#q mail --mbox x -m "$(cat ../stable-queue/00)" --sender gregkh@lf.org --from gregkh@lf.org --to foo@foo --subject "This is the subject"

cd ${TMP_DIR}
${STABLE_QUEUE}../mbox2send ${ROOT_VERSION} ${MBOX}
< ${MBOX}.new formail -ds sh -c 'cat > msg.$FILENO'

echo "cd ${TMP_DIR}"
